# 2018-Hack-Kstate

<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><link rel="stylesheet" type="text/css" href="/+static/base.8PwAX-dsywmU2hx_vi_YSA.cache.css"/><link rel="stylesheet" type="text/css" href="/+static/doc.MnCWV4K3oUOUF03WOG9dKw.cache.css"/><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.pZ5FqzM6cPxAflH0va2Ucw.cache.css"/><!-- default customHeadTagPart --></head><body class="Site"><header class="Site-header "><div class="Header"><div class="Header-title"></div></div></header><div class="Site-content Site-Content--markdown"><div class="Container"><div class="doc"><h2><a class="h" name="Android-Init-Language" href="#Android-Init-Language"><span></span></a><a class="h" name="android-init-language" href="#android-init-language"><span></span></a>Android Init Language</h2><p>The Android Init Language consists of five broad classes of statements: Actions, Commands, Services, Options, and Imports.</p><p>All of these are line-oriented, consisting of tokens separated by whitespace.  The c-style backslash escapes may be used to insert whitespace into a token.  Double quotes may also be used to prevent whitespace from breaking text into multiple tokens.  The backslash, when it is the last character on a line, may be used for line-folding.</p><p>Lines which start with a <code class="code">#</code> (leading whitespace allowed) are comments.</p><p>System properties can be expanded using the syntax <code class="code">${property.name}</code>. This also works in contexts where concatenation is required, such as <code class="code">import /init.recovery.${ro.hardware}.rc</code>.</p><p>Actions and Services implicitly declare a new section.  All commands or options belong to the section most recently declared.  Commands or options before the first section are ignored.</p><p>Services have unique names.  If a second Service is defined with the same name as an existing one, it is ignored and an error message is logged.</p><h2><a class="h" name="Init-rc-Files" href="#Init-rc-Files"><span></span></a><a class="h" name="init-rc-files" href="#init-rc-files"><span></span></a>Init .rc Files</h2><p>The init language is used in plain text files that take the .rc file extension.  There are typically multiple of these in multiple locations on the system, described below.</p><p>/init.rc is the primary .rc file and is loaded by the init executable at the beginning of its execution.  It is responsible for the initial set up of the system.</p><p>Devices that mount /system, /vendor through the first stage mount mechanism load all of the files contained within the /{system,vendor,odm}/etc/init/ directories immediately after loading the primary /init.rc.  This is explained in more details in the Imports section of this file.</p><p>Legacy devices without the first stage mount mechanism do the following:</p><ol><li>/init.rc imports /init.${ro.hardware}.rc which is the primary vendor supplied .rc file.</li><li>During the mount_all command, the init executable loads all of the files contained within the /{system,vendor,odm}/etc/init/ directories. These directories are intended for all Actions and Services used after file system mounting.</li></ol><p>One may specify paths in the mount_all command line to have it import .rc files at the specified paths instead of the default ones listed above. This is primarily for supporting factory mode and other non-standard boot modes.  The three default paths should be used for the normal boot process.</p><p>The intention of these directories is:</p><ol><li>/system/etc/init/ is for core system items such as SurfaceFlinger, MediaService, and logcatd.</li><li>/vendor/etc/init/ is for SoC vendor items such as actions or daemons needed for core SoC functionality.</li><li>/odm/etc/init/ is for device manufacturer items such as actions or daemons needed for motion sensor or other peripheral functionality.</li></ol><p>All services whose binaries reside on the system, vendor, or odm partitions should have their service entries placed into a corresponding init .rc file, located in the /etc/init/ directory of the partition where they reside.  There is a build system macro, LOCAL_INIT_RC, that handles this for developers.  Each init .rc file should additionally contain any actions associated with its service.</p><p>An example is the logcatd.rc and Android.mk files located in the system/core/logcat directory.  The LOCAL_INIT_RC macro in the Android.mk file places logcatd.rc in /system/etc/init/ during the build process.  Init loads logcatd.rc during the mount_all command and allows the service to be run and the action to be queued when appropriate.</p><p>This break up of init .rc files according to their daemon is preferred to the previously used monolithic init .rc files.  This approach ensures that the only service entries that init reads and the only actions that init performs correspond to services whose binaries are in fact present on the file system, which was not the case with the monolithic init .rc files.  This additionally will aid in merge conflict resolution when multiple services are added to the system, as each one will go into a separate file.</p><p>There are two options &ldquo;early&rdquo; and &ldquo;late&rdquo; in mount_all command which can be set after optional paths. With &ldquo;--early&rdquo; set, the init executable will skip mounting entries with &ldquo;latemount&rdquo; flag and triggering fs encryption state event. With &ldquo;--late&rdquo; set, init executable will only mount entries with &ldquo;latemount&rdquo; flag but skip importing rc files. By default, no option is set, and mount_all will process all entries in the given fstab.</p><h2><a class="h" name="Actions" href="#Actions"><span></span></a><a class="h" name="actions" href="#actions"><span></span></a>Actions</h2><p>Actions are named sequences of commands.  Actions have a trigger which is used to determine when the action is executed.  When an event occurs which matches an action&#39;s trigger, that action is added to the tail of a to-be-executed queue (unless it is already on the queue).</p><p>Each action in the queue is dequeued in sequence and each command in that action is executed in sequence.  Init handles other activities (device creation/destruction, property setting, process restarting) &ldquo;between&rdquo; the execution of the commands in activities.</p><p>Actions take the form of:</p><pre class="code">on &lt;trigger&gt; [&amp;&amp; &lt;trigger&gt;]*
   &lt;command&gt;
   &lt;command&gt;
   &lt;command&gt;
</pre><p>Actions are added to the queue and executed based on the order that the file that contains them was parsed (see the Imports section), then sequentially within an individual file.</p><p>For example if a file contains:</p><pre class="code">on boot
   setprop a 1
   setprop b 2

on boot &amp;&amp; property:true=true
   setprop c 1
   setprop d 2

on boot
   setprop e 1
   setprop f 2
</pre><p>Then when the <code class="code">boot</code> trigger occurs and assuming the property <code class="code">true</code> equals <code class="code">true</code>, then the order of the commands executed will be:</p><pre class="code">setprop a 1
setprop b 2
setprop c 1
setprop d 2
setprop e 1
setprop f 2
</pre><h2><a class="h" name="Services" href="#Services"><span></span></a><a class="h" name="services" href="#services"><span></span></a>Services</h2><p>Services are programs which init launches and (optionally) restarts when they exit.  Services take the form of:</p><pre class="code">service &lt;name&gt; &lt;pathname&gt; [ &lt;argument&gt; ]*
   &lt;option&gt;
   &lt;option&gt;
   ...
</pre><h2><a class="h" name="Options" href="#Options"><span></span></a><a class="h" name="options" href="#options"><span></span></a>Options</h2><p>Options are modifiers to services.  They affect how and when init runs the service.</p><p><code class="code">capabilities &lt;capability&gt; [ &lt;capability&gt;\* ]</code></p><blockquote><p>Set capabilities when exec&#39;ing this service. &lsquo;capability&rsquo; should be a Linux capability without the &ldquo;CAP_&rdquo; prefix, like &ldquo;NET_ADMIN&rdquo; or &ldquo;SETPCAP&rdquo;. See <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">http://man7.org/linux/man-pages/man7/capabilities.7.html</a> for a list of Linux capabilities.</p></blockquote><p><code class="code">class &lt;name&gt; [ &lt;name&gt;\* ]</code></p><blockquote><p>Specify class names for the service.  All services in a named class may be started or stopped together.  A service is in the class &ldquo;default&rdquo; if one is not specified via the class option. Additional classnames beyond the (required) first one are used to group services. The <code class="code">animation</code> class should include all services necessary for both boot animation and shutdown animation. As these services can be launched very early during bootup and can run until the last stage of shutdown, access to /data partition is not guaranteed. These services can check files under /data but it should not keep files opened and should work when /data is not available.</p></blockquote><p><code class="code">console [&lt;console&gt;]</code></p><blockquote><p>This service needs a console. The optional second parameter chooses a specific console instead of the default. The default &ldquo;/dev/console&rdquo; can be changed by setting the &ldquo;androidboot.console&rdquo; kernel parameter. In all cases the leading &ldquo;/dev/&rdquo; should be omitted, so &ldquo;/dev/tty0&rdquo; would be specified as just &ldquo;console tty0&rdquo;.</p></blockquote><p><code class="code">critical</code></p><blockquote><p>This is a device-critical service. If it exits more than four times in four minutes, the device will reboot into bootloader.</p></blockquote><p><code class="code">disabled</code></p><blockquote><p>This service will not automatically start with its class. It must be explicitly started by name or by interface name.</p></blockquote><p><code class="code">enter_namespace &lt;type&gt; &lt;path&gt;</code></p><blockquote><p>Enters the namespace of type <em>type</em> located at <em>path</em>. Only network namespaces are supported with <em>type</em> set to &ldquo;net&rdquo;. Note that only one namespace of a given <em>type</em> may be entered.</p></blockquote><p><code class="code">file &lt;path&gt; &lt;type&gt;</code></p><blockquote><p>Open a file path and pass its fd to the launched process. <em>type</em> must be &ldquo;r&rdquo;, &ldquo;w&rdquo; or &ldquo;rw&rdquo;.  For native executables see libcutils android_get_control_file().</p></blockquote><p><code class="code">group &lt;groupname&gt; [ &lt;groupname&gt;\* ]</code></p><blockquote><p>Change to &lsquo;groupname&rsquo; before exec&#39;ing this service.  Additional groupnames beyond the (required) first one are used to set the supplemental groups of the process (via setgroups()). Currently defaults to root.  (??? probably should default to nobody)</p></blockquote><p><code class="code">interface &lt;interface name&gt; &lt;instance name&gt;</code></p><blockquote><p>Associates this service with a list of the HIDL services that it provides. The interface name must be a fully-qualified name and not a value name. This is used to allow hwservicemanager to lazily start services. When multiple interfaces are served, this tag should be used multiple times. For example: interface <a href="mailto:vendor.foo.bar@1.0">vendor.foo.bar@1.0</a>::IBaz default</p></blockquote><p><code class="code">ioprio &lt;class&gt; &lt;priority&gt;</code></p><blockquote><p>Sets the IO priority and IO priority class for this service via the SYS_ioprio_set syscall. <em>class</em> must be one of &ldquo;rt&rdquo;, &ldquo;be&rdquo;, or &ldquo;idle&rdquo;. <em>priority</em> must be an integer in the range 0 - 7.</p></blockquote><p><code class="code">keycodes &lt;keycode&gt; [ &lt;keycode&gt;\* ]</code></p><blockquote><p>Sets the keycodes that will trigger this service. If all of the keys corresponding to the passed keycodes are pressed at once, the service will start. This is typically used to start the bugreport service.</p></blockquote><blockquote><p>This option may take a property instead of a list of keycodes. In this case, only one option is provided: the property name in the typical property expansion format. The property must contain a comma separated list of keycode values or the text &lsquo;none&rsquo; to indicate that this service does not respond to keycodes.</p></blockquote><blockquote><p>For example, <code class="code">keycodes ${some.property.name:-none}</code> where some.property.name expands to &ldquo;123,124,125&rdquo;. Since keycodes are handled very early in init, only PRODUCT_DEFAULT_PROPERTY_OVERRIDES properties can be used.</p></blockquote><p><code class="code">memcg.limit_in_bytes &lt;value&gt;</code></p><blockquote><p>Sets the child&#39;s memory.limit_in_bytes to the specified value (only if memcg is mounted), which must be equal or greater than 0.</p></blockquote><p><code class="code">memcg.soft_limit_in_bytes &lt;value&gt;</code></p><blockquote><p>Sets the child&#39;s memory.soft_limit_in_bytes to the specified value (only if memcg is mounted), which must be equal or greater than 0.</p></blockquote><p><code class="code">memcg.swappiness &lt;value&gt;</code></p><blockquote><p>Sets the child&#39;s memory.swappiness to the specified value (only if memcg is mounted), which must be equal or greater than 0.</p></blockquote><p><code class="code">namespace &lt;pid|mnt&gt;</code></p><blockquote><p>Enter a new PID or mount namespace when forking the service.</p></blockquote><p><code class="code">oneshot</code></p><blockquote><p>Do not restart the service when it exits.</p></blockquote><p><code class="code">onrestart</code></p><blockquote><p>Execute a Command (see below) when service restarts.</p></blockquote><p><code class="code">oom_score_adjust &lt;value&gt;</code></p><blockquote><p>Sets the child&#39;s /proc/self/oom_score_adj to the specified value, which must range from -1000 to 1000.</p></blockquote><p><code class="code">override</code></p><blockquote><p>Indicates that this service definition is meant to override a previous definition for a service with the same name. This is typically meant for services on /odm to override those defined on /vendor. The last service definition that init parses with this keyword is the service definition will use for this service. Pay close attention to the order in which init.rc files are parsed, since it has some peculiarities for backwards compatibility reasons. The &lsquo;imports&rsquo; section of this file has more details on the order.</p></blockquote><p><code class="code">priority &lt;priority&gt;</code></p><blockquote><p>Scheduling priority of the service process. This value has to be in range -20 to 19. Default priority is 0. Priority is set via setpriority().</p></blockquote><p><code class="code">restart_period &lt;seconds&gt;</code></p><blockquote><p>If a non-oneshot service exits, it will be restarted at its start time plus this period. It defaults to 5s to rate limit crashing services. This can be increased for services that are meant to run periodically. For example, it may be set to 3600 to indicate that the service should run every hour or 86400 to indicate that the service should run every day.</p></blockquote><p><code class="code">rlimit &lt;resource&gt; &lt;cur&gt; &lt;max&gt;</code></p><blockquote><p>This applies the given rlimit to the service. rlimits are inherited by child processes, so this effectively applies the given rlimit to the process tree started by this service. It is parsed similarly to the setrlimit command specified below.</p></blockquote><p><code class="code">seclabel &lt;seclabel&gt;</code></p><blockquote><p>Change to &lsquo;seclabel&rsquo; before exec&#39;ing this service. Primarily for use by services run from the rootfs, e.g. ueventd, adbd. Services on the system partition can instead use policy-defined transitions based on their file security context. If not specified and no transition is defined in policy, defaults to the init context.</p></blockquote><p><code class="code">setenv &lt;name&gt; &lt;value&gt;</code></p><blockquote><p>Set the environment variable <em>name</em> to <em>value</em> in the launched process.</p></blockquote><p><code class="code">shutdown &lt;shutdown_behavior&gt;</code></p><blockquote><p>Set shutdown behavior of the service process. When this is not specified, the service is killed during shutdown process by using SIGTERM and SIGKILL. The service with shutdown_behavior of &ldquo;critical&rdquo; is not killed during shutdown until shutdown times out. When shutdown times out, even services tagged with &ldquo;shutdown critical&rdquo; will be killed. When the service tagged with &ldquo;shutdown critical&rdquo; is not running when shut down starts, it will be started.</p></blockquote><p><code class="code">sigstop</code></p><blockquote><p>Send SIGSTOP to the service immediately before exec is called. This is intended for debugging. See the below section on debugging for how this can be used.</p></blockquote><p><code class="code">socket &lt;name&gt; &lt;type&gt; &lt;perm&gt; [ &lt;user&gt; [ &lt;group&gt; [ &lt;seclabel&gt; ] ] ]</code></p><blockquote><p>Create a unix domain socket named /dev/socket/<em>name</em> and pass its fd to the launched process.  <em>type</em> must be &ldquo;dgram&rdquo;, &ldquo;stream&rdquo; or &ldquo;seqpacket&rdquo;.  User and group default to 0.  &lsquo;seclabel&rsquo; is the SELinux security context for the socket.  It defaults to the service security context, as specified by seclabel or computed based on the service executable file security context. For native executables see libcutils android_get_control_socket().</p></blockquote><p><code class="code">timeout_period &lt;seconds&gt;</code></p><blockquote><p>Provide a timeout after which point the service will be killed. The oneshot keyword is respected here, so oneshot services do not automatically restart, however all other services will. This is particularly useful for creating a periodic service combined with the restart_period option described above.</p></blockquote><p><code class="code">user &lt;username&gt;</code></p><blockquote><p>Change to &lsquo;username&rsquo; before exec&#39;ing this service. Currently defaults to root.  (??? probably should default to nobody) As of Android M, processes should use this option even if they require Linux capabilities.  Previously, to acquire Linux capabilities, a process would need to run as root, request the capabilities, then drop to its desired uid.  There is a new mechanism through fs_config that allows device manufacturers to add Linux capabilities to specific binaries on a file system that should be used instead. This mechanism is described on <a href="http://source.android.com/devices/tech/config/filesystem.html">http://source.android.com/devices/tech/config/filesystem.html</a>.  When using this new mechanism, processes can use the user option to select their desired uid without ever running as root. As of Android O, processes can also request capabilities directly in their .rc files. See the &ldquo;capabilities&rdquo; option below.</p></blockquote><p><code class="code">writepid &lt;file&gt; [ &lt;file&gt;\* ]</code></p><blockquote><p>Write the child&#39;s pid to the given files when it forks. Meant for cgroup/cpuset usage. If no files under /dev/cpuset/ are specified, but the system property &lsquo;ro.cpuset.default&rsquo; is set to a non-empty cpuset name (e.g. &lsquo;/foreground&rsquo;), then the pid is written to file /dev/cpuset/<em>cpuset_name</em>/tasks.</p></blockquote><h2><a class="h" name="Triggers" href="#Triggers"><span></span></a><a class="h" name="triggers" href="#triggers"><span></span></a>Triggers</h2><p>Triggers are strings which can be used to match certain kinds of events and used to cause an action to occur.</p><p>Triggers are subdivided into event triggers and property triggers.</p><p>Event triggers are strings triggered by the &lsquo;trigger&rsquo; command or by the QueueEventTrigger() function within the init executable.  These take the form of a simple string such as &lsquo;boot&rsquo; or &lsquo;late-init&rsquo;.</p><p>Property triggers are strings triggered when a named property changes value to a given new value or when a named property changes value to any new value.  These take the form of &lsquo;property:=&rsquo; and &lsquo;property:=*&rsquo; respectively.  Property triggers are additionally evaluated and triggered accordingly during the initial boot phase of init.</p><p>An Action can have multiple property triggers but may only have one event trigger.</p><p>For example: <code class="code">on boot &amp;&amp; property:a=b</code> defines an action that is only executed when the &lsquo;boot&rsquo; event trigger happens and the property a equals b.</p><p><code class="code">on property:a=b &amp;&amp; property:c=d</code> defines an action that is executed at three times:</p><ol><li>During initial boot if property a=b and property c=d.</li><li>Any time that property a transitions to value b, while property c already equals d.</li><li>Any time that property c transitions to value d, while property a already equals b.</li></ol><h2><a class="h" name="Commands" href="#Commands"><span></span></a><a class="h" name="commands" href="#commands"><span></span></a>Commands</h2><p><code class="code">bootchart [start|stop]</code></p><blockquote><p>Start/stop bootcharting. These are present in the default init.rc files, but bootcharting is only active if the file /data/bootchart/enabled exists; otherwise bootchart start/stop are no-ops.</p></blockquote><p><code class="code">chmod &lt;octal-mode&gt; &lt;path&gt;</code></p><blockquote><p>Change file access permissions.</p></blockquote><p><code class="code">chown &lt;owner&gt; &lt;group&gt; &lt;path&gt;</code></p><blockquote><p>Change file owner and group.</p></blockquote><p><code class="code">class_start &lt;serviceclass&gt;</code></p><blockquote><p>Start all services of the specified class if they are not already running.  See the start entry for more information on starting services.</p></blockquote><p><code class="code">class_stop &lt;serviceclass&gt;</code></p><blockquote><p>Stop and disable all services of the specified class if they are currently running.</p></blockquote><p><code class="code">class_reset &lt;serviceclass&gt;</code></p><blockquote><p>Stop all services of the specified class if they are currently running, without disabling them. They can be restarted later using <code class="code">class_start</code>.</p></blockquote><p><code class="code">class_restart &lt;serviceclass&gt;</code></p><blockquote><p>Restarts all services of the specified class.</p></blockquote><p><code class="code">copy &lt;src&gt; &lt;dst&gt;</code></p><blockquote><p>Copies a file. Similar to write, but useful for binary/large amounts of data. Regarding to the src file, copying from symbolic link file and world-writable or group-writable files are not allowed. Regarding to the dst file, the default mode created is 0600 if it does not exist. And it will be truncated if dst file is a normal regular file and already exists.</p></blockquote><p><code class="code">domainname &lt;name&gt;</code></p><blockquote><p>Set the domain name.</p></blockquote><p><code class="code">enable &lt;servicename&gt;</code></p><blockquote><p>Turns a disabled service into an enabled one as if the service did not specify disabled. If the service is supposed to be running, it will be started now. Typically used when the bootloader sets a variable that indicates a specific service should be started when needed. E.g.</p></blockquote><pre class="code">on property:ro.boot.myfancyhardware=1
    enable my_fancy_service_for_my_fancy_hardware
</pre><p><code class="code">exec [ &lt;seclabel&gt; [ &lt;user&gt; [ &lt;group&gt;\* ] ] ] -- &lt;command&gt; [ &lt;argument&gt;\* ]</code></p><blockquote><p>Fork and execute command with the given arguments. The command starts after &ldquo;--&rdquo; so that an optional security context, user, and supplementary groups can be provided. No other commands will be run until this one finishes. <em>seclabel</em> can be a - to denote default. Properties are expanded within <em>argument</em>. Init halts executing commands until the forked process exits.</p></blockquote><p><code class="code">exec_background [ &lt;seclabel&gt; [ &lt;user&gt; [ &lt;group&gt;\* ] ] ] -- &lt;command&gt; [ &lt;argument&gt;\* ]</code></p><blockquote><p>Fork and execute command with the given arguments. This is handled similarly to the <code class="code">exec</code> command. The difference is that init does not halt executing commands until the process exits for <code class="code">exec_background</code>.</p></blockquote><p><code class="code">exec_start &lt;service&gt;</code></p><blockquote><p>Start a given service and halt the processing of additional init commands until it returns.  The command functions similarly to the <code class="code">exec</code> command, but uses an existing service definition in place of the exec argument vector.</p></blockquote><p><code class="code">export &lt;name&gt; &lt;value&gt;</code></p><blockquote><p>Set the environment variable <em>name</em> equal to <em>value</em> in the global environment (which will be inherited by all processes started after this command is executed)</p></blockquote><p><code class="code">hostname &lt;name&gt;</code></p><blockquote><p>Set the host name.</p></blockquote><p><code class="code">ifup &lt;interface&gt;</code></p><blockquote><p>Bring the network interface <em>interface</em> online.</p></blockquote><p><code class="code">insmod [-f] &lt;path&gt; [&lt;options&gt;]</code></p><blockquote><p>Install the module at <em>path</em> with the specified options. -f: force installation of the module even if the version of the running kernel and the version of the kernel for which the module was compiled do not match.</p></blockquote><p><code class="code">load_all_props</code></p><blockquote><p>Loads properties from /system, /vendor, et cetera. This is included in the default init.rc.</p></blockquote><p><code class="code">load_persist_props</code></p><blockquote><p>Loads persistent properties when /data has been decrypted. This is included in the default init.rc.</p></blockquote><p><code class="code">loglevel &lt;level&gt;</code></p><blockquote><p>Sets the kernel log level to level. Properties are expanded within <em>level</em>.</p></blockquote><p><code class="code">mkdir &lt;path&gt; [mode] [owner] [group]</code></p><blockquote><p>Create a directory at <em>path</em>, optionally with the given mode, owner, and group. If not provided, the directory is created with permissions 755 and owned by the root user and root group. If provided, the mode, owner and group will be updated if the directory exists already.</p></blockquote><p><code class="code">mount_all &lt;fstab&gt; [ &lt;path&gt; ]\* [--&lt;option&gt;]</code></p><blockquote><p>Calls fs_mgr_mount_all on the given fs_mgr-format fstab and imports .rc files at the specified paths (e.g., on the partitions just mounted) with optional options &ldquo;early&rdquo; and &ldquo;late&rdquo;. Refer to the section of &ldquo;Init .rc Files&rdquo; for detail.</p></blockquote><p><code class="code">mount &lt;type&gt; &lt;device&gt; &lt;dir&gt; [ &lt;flag&gt;\* ] [&lt;options&gt;]</code></p><blockquote><p>Attempt to mount the named device at the directory <em>dir</em> _flag_s include &ldquo;ro&rdquo;, &ldquo;rw&rdquo;, &ldquo;remount&rdquo;, &ldquo;noatime&rdquo;, ... <em>options</em> include &ldquo;barrier=1&rdquo;, &ldquo;noauto_da_alloc&rdquo;, &ldquo;discard&rdquo;, ... as a comma separated string, eg: barrier=1,noauto_da_alloc</p></blockquote><p><code class="code">restart &lt;service&gt;</code></p><blockquote><p>Stops and restarts a running service, does nothing if the service is currently restarting, otherwise, it just starts the service.</p></blockquote><p><code class="code">restorecon &lt;path&gt; [ &lt;path&gt;\* ]</code></p><blockquote><p>Restore the file named by <em>path</em> to the security context specified in the file_contexts configuration. Not required for directories created by the init.rc as these are automatically labeled correctly by init.</p></blockquote><p><code class="code">restorecon_recursive &lt;path&gt; [ &lt;path&gt;\* ]</code></p><blockquote><p>Recursively restore the directory tree named by <em>path</em> to the security contexts specified in the file_contexts configuration.</p></blockquote><p><code class="code">rm &lt;path&gt;</code></p><blockquote><p>Calls unlink(2) on the given path. You might want to use &ldquo;exec -- rm ...&rdquo; instead (provided the system partition is already mounted).</p></blockquote><p><code class="code">rmdir &lt;path&gt;</code></p><blockquote><p>Calls rmdir(2) on the given path.</p></blockquote><p><code class="code">readahead &lt;file|dir&gt; [--fully]</code></p><blockquote><p>Calls readahead(2) on the file or files within given directory. Use option --fully to read the full file content.</p></blockquote><p><code class="code">setprop &lt;name&gt; &lt;value&gt;</code></p><blockquote><p>Set system property <em>name</em> to <em>value</em>. Properties are expanded within <em>value</em>.</p></blockquote><p><code class="code">setrlimit &lt;resource&gt; &lt;cur&gt; &lt;max&gt;</code></p><blockquote><p>Set the rlimit for a resource. This applies to all processes launched after the limit is set. It is intended to be set early in init and applied globally. <em>resource</em> is best specified using its text representation (&lsquo;cpu&rsquo;, &lsquo;rtio&rsquo;, etc or &lsquo;RLIM_CPU&rsquo;, &lsquo;RLIM_RTIO&rsquo;, etc). It also may be specified as the int value that the resource enum corresponds to. <em>cur</em> and <em>max</em> can be &lsquo;unlimited&rsquo; or &lsquo;-1&rsquo; to indicate an infinite rlimit.</p></blockquote><p><code class="code">start &lt;service&gt;</code></p><blockquote><p>Start a service running if it is not already running. Note that this is <em>not</em> synchronous, and even if it were, there is no guarantee that the operating system&lsquo;s scheduler will execute the service sufficiently to guarantee anything about the service&rsquo;s status.</p></blockquote><blockquote><p>This creates an important consequence that if the service offers functionality to other services, such as providing a communication channel, simply starting this service before those services is <em>not</em> sufficient to guarantee that the channel has been set up before those services ask for it.  There must be a separate mechanism to make any such guarantees.</p></blockquote><p><code class="code">stop &lt;service&gt;</code></p><blockquote><p>Stop a service from running if it is currently running.</p></blockquote><p><code class="code">swapon_all &lt;fstab&gt;</code></p><blockquote><p>Calls fs_mgr_swapon_all on the given fstab file.</p></blockquote><p><code class="code">symlink &lt;target&gt; &lt;path&gt;</code></p><blockquote><p>Create a symbolic link at <em>path</em> with the value <em>target</em></p></blockquote><p><code class="code">sysclktz &lt;mins_west_of_gmt&gt;</code></p><blockquote><p>Set the system clock base (0 if system clock ticks in GMT)</p></blockquote><p><code class="code">trigger &lt;event&gt;</code></p><blockquote><p>Trigger an event.  Used to queue an action from another action.</p></blockquote><p><code class="code">umount &lt;path&gt;</code></p><blockquote><p>Unmount the filesystem mounted at that path.</p></blockquote><p><code class="code">verity_load_state</code></p><blockquote><p>Internal implementation detail used to load dm-verity state.</p></blockquote><p><code class="code">verity_update_state &lt;mount-point&gt;</code></p><blockquote><p>Internal implementation detail used to update dm-verity state and set the partition.<em>mount-point</em>.verified properties used by adb remount because fs_mgr can&#39;t set them directly itself.</p></blockquote><p><code class="code">wait &lt;path&gt; [ &lt;timeout&gt; ]</code></p><blockquote><p>Poll for the existence of the given file and return when found, or the timeout has been reached. If timeout is not specified it currently defaults to five seconds.</p></blockquote><p><code class="code">wait_for_prop &lt;name&gt; &lt;value&gt;</code></p><blockquote><p>Wait for system property <em>name</em> to be <em>value</em>. Properties are expanded within <em>value</em>. If property <em>name</em> is already set to <em>value</em>, continue immediately.</p></blockquote><p><code class="code">write &lt;path&gt; &lt;content&gt;</code></p><blockquote><p>Open the file at <em>path</em> and write a string to it with write(2). If the file does not exist, it will be created. If it does exist, it will be truncated. Properties are expanded within <em>content</em>.</p></blockquote><h2><a class="h" name="Imports" href="#Imports"><span></span></a><a class="h" name="imports" href="#imports"><span></span></a>Imports</h2><p><code class="code">import &lt;path&gt;</code></p><blockquote><p>Parse an init config file, extending the current configuration. If <em>path</em> is a directory, each file in the directory is parsed as a config file. It is not recursive, nested directories will not be parsed.</p></blockquote><p>The import keyword is not a command, but rather its own section, meaning that it does not happen as part of an Action, but rather, imports are handled as a file is being parsed and follow the below logic.</p><p>There are only three times where the init executable imports .rc files:</p><ol><li>When it imports /init.rc or the script indicated by the property <code class="code">ro.boot.init_rc</code> during initial boot.</li><li>When it imports /{system,vendor,odm}/etc/init/ for first stage mount devices immediately after importing /init.rc.</li><li>When it imports /{system,vendor,odm}/etc/init/ or .rc files at specified paths during mount_all.</li></ol><p>The order that files are imported is a bit complex for legacy reasons and to keep backwards compatibility.  It is not strictly guaranteed.</p><p>The only correct way to guarantee that a command has been run before a different command is to either 1) place it in an Action with an earlier executed trigger, or 2) place it in an Action with the same trigger within the same file at an earlier line.</p><p>Nonetheless, the defacto order for first stage mount devices is:</p><ol><li>/init.rc is parsed then recursively each of its imports are parsed.</li><li>The contents of /system/etc/init/ are alphabetized and parsed sequentially, with imports happening recursively after each file is parsed.</li><li>Step 2 is repeated for /vendor/etc/init then /odm/etc/init</li></ol><p>The below pseudocode may explain this more clearly:</p><pre class="code">fn Import(file)
  Parse(file)
  for (import : file.imports)
    Import(import)

Import(/init.rc)
Directories = [/system/etc/init, /vendor/etc/init, /odm/etc/init]
for (directory : Directories)
  files = &lt;Alphabetical order of directory&#39;s contents&gt;
  for (file : files)
    Import(file)
</pre><h2><a class="h" name="Properties" href="#Properties"><span></span></a><a class="h" name="properties" href="#properties"><span></span></a>Properties</h2><p>Init provides information about the services that it is responsible for via the below properties.</p><p><code class="code">init.svc.&lt;name&gt;</code></p><blockquote><p>State of a named service (&ldquo;stopped&rdquo;, &ldquo;stopping&rdquo;, &ldquo;running&rdquo;, &ldquo;restarting&rdquo;)</p></blockquote><h2><a class="h" name="Boot-timing" href="#Boot-timing"><span></span></a><a class="h" name="boot-timing" href="#boot-timing"><span></span></a>Boot timing</h2><p>Init records some boot timing information in system properties.</p><p><code class="code">ro.boottime.init</code></p><blockquote><p>Time after boot in ns (via the CLOCK_BOOTTIME clock) at which the first stage of init started.</p></blockquote><p><code class="code">ro.boottime.init.selinux</code></p><blockquote><p>How long it took the first stage to initialize SELinux.</p></blockquote><p><code class="code">ro.boottime.init.cold_boot_wait</code></p><blockquote><p>How long init waited for ueventd&#39;s coldboot phase to end.</p></blockquote><p><code class="code">ro.boottime.&lt;service-name&gt;</code></p><blockquote><p>Time after boot in ns (via the CLOCK_BOOTTIME clock) that the service was first started.</p></blockquote><h2><a class="h" name="Bootcharting" href="#Bootcharting"><span></span></a><a class="h" name="bootcharting" href="#bootcharting"><span></span></a>Bootcharting</h2><p>This version of init contains code to perform &ldquo;bootcharting&rdquo;: generating log files that can be later processed by the tools provided by <a href="http://www.bootchart.org/">http://www.bootchart.org/</a>.</p><p>On the emulator, use the -bootchart <em>timeout</em> option to boot with bootcharting activated for <em>timeout</em> seconds.</p><p>On a device:</p><pre class="code">adb shell &#39;touch /data/bootchart/enabled&#39;
</pre><p>Don&lsquo;t forget to delete this file when you&rsquo;re done collecting data!</p><p>The log files are written to /data/bootchart/. A script is provided to retrieve them and create a bootchart.tgz file that can be used with the bootchart command-line utility:</p><pre class="code">sudo apt-get install pybootchartgui
# grab-bootchart.sh uses $ANDROID_SERIAL.
$ANDROID_BUILD_TOP/system/core/init/grab-bootchart.sh
</pre><p>One thing to watch for is that the bootchart will show init as if it started running at 0s. You&#39;ll have to look at dmesg to work out when the kernel actually started init.</p><h2><a class="h" name="Comparing-two-bootcharts" href="#Comparing-two-bootcharts"><span></span></a><a class="h" name="comparing-two-bootcharts" href="#comparing-two-bootcharts"><span></span></a>Comparing two bootcharts</h2><p>A handy script named compare-bootcharts.py can be used to compare the start/end time of selected processes. The aforementioned grab-bootchart.sh will leave a bootchart tarball named bootchart.tgz at /tmp/android-bootchart. If two such barballs are preserved on the host machine under different directories, the script can list the timestamps differences. For example:</p><p>Usage: system/core/init/compare-bootcharts.py <em>base-bootchart-dir</em> <em>exp-bootchart-dir</em></p><pre class="code">process: baseline experiment (delta) - Unit is ms (a jiffy is 10 ms on the system)
------------------------------------
/init: 50 40 (-10)
/system/bin/surfaceflinger: 4320 4470 (+150)
/system/bin/bootanimation: 6980 6990 (+10)
zygote64: 10410 10640 (+230)
zygote: 10410 10640 (+230)
system_server: 15350 15150 (-200)
bootanimation ends at: 33790 31230 (-2560)
</pre><h2><a class="h" name="Systrace" href="#Systrace"><span></span></a><a class="h" name="systrace" href="#systrace"><span></span></a>Systrace</h2><p>Systrace (<a href="http://developer.android.com/tools/help/systrace.html">http://developer.android.com/tools/help/systrace.html</a>) can be used for obtaining performance analysis reports during boot time on userdebug or eng builds.</p><p>Here is an example of trace events of &ldquo;wm&rdquo; and &ldquo;am&rdquo; categories:</p><pre class="code">$ANDROID_BUILD_TOP/external/chromium-trace/systrace.py \
      wm am --boot
</pre><p>This command will cause the device to reboot. After the device is rebooted and the boot sequence has finished, the trace report is obtained from the device and written as trace.html on the host by hitting Ctrl+C.</p><p>Limitation: recording trace events is started after persistent properties are loaded, so the trace events that are emitted before that are not recorded. Several services such as vold, surfaceflinger, and servicemanager are affected by this limitation since they are started before persistent properties are loaded. Zygote initialization and the processes that are forked from the zygote are not affected.</p><h2><a class="h" name="Debugging-init" href="#Debugging-init"><span></span></a><a class="h" name="debugging-init" href="#debugging-init"><span></span></a>Debugging init</h2><p>Launching init services without init is not recommended as init sets up a significant amount of environment (user, groups, security label, capabilities, etc) that is hard to replicate manually.</p><p>If it is required to debug a service from its very start, the <code class="code">sigstop</code> service option is added. This option will send SIGSTOP to a service immediately before calling exec. This gives a window where developers can attach a debugger, strace, etc before continuing the service with SIGCONT.</p><p>This flag can also be dynamically controled via the ctl.sigstop_on and ctl.sigstop_off properties.</p><p>Below is an example of dynamically debugging logd via the above:</p><pre class="code">stop logd
setprop ctl.sigstop_on logd
start logd
ps -e | grep logd
&gt; logd          4343     1   18156   1684 do_signal_stop 538280 T init
gdbclient.py -p 4343
b main
c
c
c
&gt; Breakpoint 1, main (argc=1, argv=0x7ff8c9a488) at system/core/logd/main.cpp:427
</pre><p>Below is an example of doing the same but with strace</p><pre class="code">stop logd
setprop ctl.sigstop_on logd
start logd
ps -e | grep logd
&gt; logd          4343     1   18156   1684 do_signal_stop 538280 T init
strace -p 4343

(From a different shell)
kill -SIGCONT 4343

&gt; strace runs
</pre><h2><a class="h" name="Host-Init-Script-Verification" href="#Host-Init-Script-Verification"><span></span></a><a class="h" name="host-init-script-verification" href="#host-init-script-verification"><span></span></a>Host Init Script Verification</h2><p>Init scripts are checked for correctness during build time. Specifically the below is checked.</p><ol><li>Well formatted action, service and import sections, e.g. no actions without a preceding &lsquo;on&rsquo; line, and no extraneous lines after an &lsquo;import&rsquo; statement.</li><li>All commands map to a valid keyword and the argument count is within the correct range.</li><li>All service options are valid. This is stricter than how commands are checked as the service options&#39; arguments are fully parsed, e.g. UIDs and GIDs must resolve.</li></ol><p>There are other parts of init scripts that are only parsed at runtime and therefore not checked during build time, among them are the below.</p><ol><li>The validity of the arguments of commands, e.g. no checking if file paths actually exist, if SELinux would permit the operation, or if the UIDs and GIDs resolve.</li><li>No checking if a service exists or has a valid SELinux domain defined</li><li>No checking if a service has not been previously defined in a different init script.</li></ol></div></div></div><!-- default customFooter --><footer class="Site-footer"><div class="Footer"><span class="Footer-poweredBy">Powered by <a href="https://gerrit.googlesource.com/gitiles/">Gitiles</a>| <a href="https://policies.google.com/privacy">Privacy</a></span><div class="Footer-links"></div></div></footer></body></html>
